<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
    body {
      font-family: 'Sarabun', sans-serif;
      margin: 0; padding: 20px;
      background-color: #f0f4ff;
      color: #222;
    }
    h1 {
      text-align: center;
      color: #3f51b5;
    }
    .tab-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .tab-button {
      background-color: #3f51b5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 700;
    }
    .tab-button.active {
      background-color: #303f9f;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      background: white;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 10px;
    }
    th, td {
      padding: 12px 16px;
      border: 1px solid #ddd;
      text-align: center;
    }
    thead {
      background: linear-gradient(90deg, #3f51b5, #5c6bc0);
      color: white;
    }
    tbody tr:nth-child(odd) {
      background-color: #f9faff;
    }
    tbody tr:hover {
      background-color: #e3e8ff;
    }
    #chartContainer {
      max-width: 600px;
      margin: 30px auto 0 auto;
      background: white;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.12);
    }
    .back-btn {
      background-color: #dcdcdc;
      padding: 8px 16px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: inline-block;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h1>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>

<div class="tab-buttons">
  <button class="tab-button active" onclick="switchTab('savingTab')">üí∞ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</button>
  <button class="tab-button" onclick="switchTab('interestTab')">üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
</div>

<!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏° -->
<div class="tab-content active" id="savingTab">
  <button id="refreshBtn">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
  <table>
    <thead>
      <tr>
        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
        <th>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
        <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
        <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏±‡∏ô)</th>
        <th>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
      </tr>
    </thead>
    <tbody id="historyBody">
      <tr><td colspan="5" id="noData">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
    </tbody>
  </table>
  <div id="chartContainer" style="display:none;">
    <canvas id="summaryChart"></canvas>
  </div>
</div>

<!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ -->
<div class="tab-content" id="interestTab">
  <div class="back-btn" onclick="goBack()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</div>
  <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</h2>
  <table>
    <thead>
      <tr>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
        <th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th>
        <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      </tr>
    </thead>
    <tbody id="historyTable"></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const savingSheetURL = "https://sheetdb.io/api/v1/nlnc03ay4ibgj";
  const interestSheetURL = "https://sheetdb.io/api/v1/81umx6nj4pusk";
  const currentUser = localStorage.getItem("username");
  const tbody = document.getElementById("historyBody");
  const noDataRow = document.getElementById("noData");
  const chartContainer = document.getElementById("chartContainer");
  const refreshBtn = document.getElementById("refreshBtn");
  let chartInstance = null;

  // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°
  async function loadSavingData() {
    tbody.innerHTML = `<tr><td colspan="5" id="noData">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;
    chartContainer.style.display = 'none';

    try {
      const res = await fetch(`${savingSheetURL}?UserID=${currentUser}`);
      const data = await res.json();

      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="5" id="noData">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</td></tr>`;
        return;
      }

      const summary = {};
      data.forEach(item => {
        const key = item.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó + '|' + item.‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢;
        if (!summary[key]) {
          summary[key] = {
            ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: item.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,
            ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: item.‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢,
            ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: 0,
            ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: item['‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö'] || '-',
            ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: item.Date || '-'
          };
        }
        summary[key].‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° += Number(item['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£']) || 0;
        if (item.Date && item.Date > summary[key].‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) {
          summary[key].‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î = item.Date;
        }
      });

      tbody.innerHTML = "";
      Object.values(summary).forEach(row => {
        tbody.innerHTML += `
          <tr>
            <td>${row.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó}</td>
            <td>${row.‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢}</td>
            <td>${row.‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°.toLocaleString()}</td>
            <td>${row.‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤}</td>
            <td>${row.‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î}</td>
          </tr>
        `;
      });

      showChart(Object.values(summary));
    } catch (error) {
      tbody.innerHTML = `<tr><td colspan="5" id="noData">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
      console.error(error);
    }
  }

  function showChart(data) {
    chartContainer.style.display = 'block';
    const labels = data.map(d => d.‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢);
    const amounts = data.map(d => d.‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°);

    if (chartInstance) chartInstance.destroy();

    const ctx = document.getElementById('summaryChart').getContext('2d');
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)',
          data: amounts,
          backgroundColor: '#3f51b5',
          borderRadius: 6,
          barPercentage: 0.6,
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => ctx.parsed.y.toLocaleString() + " ‡∏ö‡∏≤‡∏ó"
            }
          }
        }
      }
    });
  }

  // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
  async function loadInterestHistory() {
    const table = document.getElementById("historyTable");
    try {
      const res = await fetch(interestSheetURL);
      const data = await res.json();
      const filtered = data.filter(row => row.UserID === currentUser);
      if (!filtered.length) {
        table.innerHTML = `<tr><td colspan="5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
      }
      filtered.reverse().forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å"] || "-"}</td>
          <td>${row["‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£"] || "-"}</td>
          <td>${row["‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢"] || "-"}</td>
          <td>${row["‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö"] || "-"}</td>
          <td>${row["Date"] || "-"}</td>
        `;
        table.appendChild(tr);
      });
    } catch (err) {
      console.error(err);
      table.innerHTML = `<tr><td colspan="5">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }
  }

  function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
  }

  function goBack() {
    history.back();
  }

  refreshBtn.addEventListener("click", loadSavingData);

  if (!currentUser) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥");
    window.location.href = "checkin.html";
  } else {
    loadSavingData();
    loadInterestHistory();
  }
</script>

</body>
</html>